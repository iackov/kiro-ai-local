# Qwen MCP Setup & Cookie Refresh

## Текущая конфигурация

Qwen MCP сервер уже настроен в вашей системе:

**Расположение**: `C:\Users\Jack\source\kiro\qwen\src\mcp_server\`

**Конфигурация MCP**: `~/.kiro/settings/mcp.json`
```json
{
  "mcpServers": {
    "qwen-chat": {
      "command": "python",
      "args": [
        "C:\\Users\\Jack\\source\\kiro\\qwen\\src\\mcp_server\\qwen_mcp_server.py"
      ],
      "env": {
        "PYTHONPATH": "C:\\Users\\Jack\\source\\kiro\\qwen\\src\\mcp_server",
        "PYTHONIOENCODING": "utf-8"
      },
      "disabled": false
    }
  }
}
```

## Обновление протухших куков

### Автоматический способ (рекомендуется)

Запустите скрипт:
```powershell
.\scripts\refresh-qwen-cookies.ps1
```

Скрипт попросит вас вставить новую cookie строку.

### Ручной способ

1. **Получите новые куки**:
   - Откройте https://chat.qwen.ai в браузере
   - Войдите в аккаунт
   - Откройте DevTools (F12) → вкладка Network
   - Отправьте любое сообщение в чат
   - Найдите запрос к `/api/v2/chat/completions`
   - Во вкладке Headers найдите `Cookie`
   - Скопируйте полное значение

2. **Обновите конфиг**:
   Откройте файл:
   ```
   C:\Users\Jack\source\kiro\qwen\src\mcp_server\qwen_config.json
   ```

3. **Замените cookie_string**:
   ```json
   {
     "cookies": {
       "cookie_string": "ВСТАВЬТЕ_СЮДА_НОВУЮ_COOKIE_СТРОКУ"
     }
   }
   ```

4. **Перезапустите MCP**:
   - В Kiro откройте панель MCP
   - Найдите сервер `qwen-chat`
   - Нажмите кнопку переподключения
   - Или перезапустите Kiro IDE

## Проверка работы

После обновления куков проверьте работу:

```
@kiro Используй qwen_chat чтобы сказать привет
```

Или через MCP инструмент напрямую в Kiro.

## Структура конфига

Файл `qwen_config.json` содержит:

- **cookies.cookie_string** - полная строка Cookie (обязательно)
- **headers** - HTTP заголовки для запросов
- **api_endpoints** - URL эндпоинтов Qwen API
- **models** - доступные модели
- **mongo** - настройки MongoDB для истории (опционально)
- **system_prompt** - системный промпт по умолчанию

## Частые проблемы

### MCP сервер не подключается

1. Проверьте что Python доступен:
   ```powershell
   python --version
   ```

2. Проверьте путь к скрипту в MCP конфиге

3. Посмотрите логи в Kiro Output panel

### Куки протухают слишком быстро

Куки Qwen обычно действительны несколько дней. Если они протухают быстрее:
- Проверьте что вы вошли в аккаунт (не гостевой режим)
- Убедитесь что копируете полную cookie строку
- Попробуйте войти заново в браузере

### Ошибка "cookie_string отсутствует"

Убедитесь что в `qwen_config.json` есть поле:
```json
{
  "cookies": {
    "cookie_string": "ваша_строка_здесь"
  }
}
```

## Доступные MCP инструменты

После настройки доступны:

- **qwen_chat** - отправка сообщений в Qwen
- **qwen_new_chat** - создание нового чата

## Интеграция с локальным RAG

Вы можете использовать Qwen вместе с локальным RAG:

1. Используйте `rag_query` для получения контекста из документов
2. Передайте контекст в `qwen_chat` для генерации ответа
3. Получите ответ, основанный на ваших локальных данных

Пример в Kiro:
```
@kiro 
1. Используй rag_query чтобы найти информацию об архитектуре
2. Используй qwen_chat чтобы объяснить найденное простыми словами
```

## MongoDB для истории чатов

MongoDB опциональна, но рекомендуется для сохранения истории чатов Qwen.

### Настройка MongoDB

1. **Запустите MongoDB** (уже включена в docker-compose.yml):
   ```powershell
   docker compose up -d mongodb
   ```

2. **Настройте Qwen для использования MongoDB**:
   ```powershell
   .\scripts\setup-qwen-mongo.ps1
   ```

3. **Проверьте подключение**:
   ```powershell
   docker exec ai-mongodb mongosh --eval "show dbs"
   ```

### Что даёт MongoDB

- **Персистентная история**: Все чаты сохраняются между сессиями
- **Поиск по истории**: Можно искать старые разговоры
- **Контекст**: Qwen помнит предыдущие сообщения в чате
- **Бэкапы**: Легко создавать резервные копии истории

### Структура данных

MongoDB хранит две коллекции:

**chats** - метаданные чатов:
```json
{
  "id": "chat_id",
  "title": "Название чата",
  "model": "qwen3-coder-plus",
  "created_at": "2025-01-16T10:00:00Z"
}
```

**messages** - сообщения:
```json
{
  "chat_id": "chat_id",
  "role": "user|assistant",
  "content": "Текст сообщения",
  "timestamp": "2025-01-16T10:00:00Z"
}
```

### Работа без MongoDB

Если MongoDB не настроена, Qwen MCP будет работать без сохранения истории:
- Каждый запрос независим
- История не сохраняется
- Меньше потребление ресурсов

Это нормально для простых запросов, но для длинных диалогов рекомендуется MongoDB.

## Безопасность

- Файл `qwen_config.json` содержит чувствительные данные (куки)
- Не коммитьте его в Git
- Не делитесь cookie строкой с другими
- Регулярно обновляйте куки для безопасности
