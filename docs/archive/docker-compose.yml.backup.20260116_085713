version: '3.8'

networks:
  ai-local-net:
    driver: bridge

volumes:
  chroma-data:
  ollama-data:
  logs-data:
  mongo-data:

services:
  # Local LLM Service (Ollama)
  ollama:
    image: ollama/ollama:latest
    container_name: ai-ollama
    networks:
      - ai-local-net
    ports:
      - "11434:11434"
    volumes:
      - ollama-data:/root/.ollama
    environment:
      - OLLAMA_HOST=0.0.0.0
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G
    restart: unless-stopped

  # RAG API Service (with embedded ChromaDB)
  rag-api:
    build:
      context: ./services/rag-api
      dockerfile: Dockerfile
    container_name: ai-rag-api
    networks:
      - ai-local-net
    ports:
      - "9001:8001"
      - "9081:8081"
    volumes:
      - ./services/rag-api:/app
      - ./data:/data
      - chroma-data:/chroma/chroma
      - logs-data:/logs
    environment:
      - OLLAMA_URL=http://ollama:11434
      - LOG_LEVEL=INFO
      - PYTHONUNBUFFERED=1
    depends_on:
      - ollama
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
    restart: unless-stopped

  # MCP Gateway Service
  mcp-gateway:
    build:
      context: ./services/mcp-gateway
      dockerfile: Dockerfile
    container_name: ai-mcp-gateway
    networks:
      - ai-local-net
    ports:
      - "9002:8002"
    volumes:
      - logs-data:/logs
    environment:
      - RAG_API_URL=http://rag-api:8001
      - LOG_LEVEL=INFO
      - PORT=8002
    depends_on:
      - rag-api
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
    restart: unless-stopped

  # MongoDB for Qwen chat history
  mongodb:
    image: mongo:7-jammy
    container_name: ai-mongodb
    networks:
      - ai-local-net
    ports:
      - "27017:27017"
    volumes:
      - mongo-data:/data/db
    environment:
      - MONGO_INITDB_DATABASE=qwen_chats
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
    restart: unless-stopped
    command: mongod --quiet --logpath /dev/null
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Architecture Engine - Self-modification system
  arch-engine:
    build:
      context: ./services/arch-engine
      dockerfile: Dockerfile
    container_name: ai-arch-engine
    networks:
      - ai-local-net
    ports:
      - "9004:8004"
    volumes:
      - .:/host
      - /var/run/docker.sock:/var/run/docker.sock
      - logs-data:/logs
    environment:
      - LOG_LEVEL=INFO
      - COMPOSE_PATH=/host/docker-compose.yml
    depends_on:
      - rag-api
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
    restart: unless-stopped
